<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pro Scoreboard – Controller</title>

<style>
:root{
  --bg:#0e1117; 
  --panel:#141923; 
  --accent:#5ee0ff; 
  --accent2:#80ff9f;
  --muted:#8a93a6; 
  --danger:#ff5470; 
  --white:#f5f7fb;
}

/* GLOBAL */
html, body {
  height:100%;
  margin:0;
  background:
    linear-gradient(rgba(0,0,0,.45), rgba(0,0,0,.65)),
    url("https://rflbrescia-netizen.github.io/anzio_scoreboard/background.jpg") 
      center/cover no-repeat fixed;
  color:var(--white);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;
}

.wrap{
  display:flex;
  flex-direction:column;
  gap:18px;
  padding:20px;
  max-width:1200px;
  margin:0 auto;
}

/* PANEL */
.card {
  background:rgba(20,25,35,0.75);
  backdrop-filter:blur(6px);
  border-radius:16px;
  padding:16px;
  box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
}

h2{
  margin:0 0 12px;
  font-size:14px;
  letter-spacing:.6px;
  text-transform:uppercase;
  color:var(--muted);
}

/* ROWS */
.row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-bottom:8px;
}

/* INPUTS */
input[type="text"],
input[type="number"],
input[type="time"],
select{
  background:#0e1420;
  border:1px solid rgba(255,255,255,.1);
  color:var(--white);
  padding:10px 12px;
  border-radius:10px;
  outline:none;
  font-weight:600;
}

input[type="file"]{
  color:var(--muted);
}

/* BUTTONS */
button{
  background:linear-gradient(135deg,#1c2433,#121826);
  border:1px solid rgba(255,255,255,.08);
  color:var(--white);
  padding:12px 16px;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
  font-size:16px;
  box-shadow:0 4px 14px rgba(0,0,0,.25);
}

button:hover{ filter:brightness(1.08); }
button:active{ transform:translateY(1px); }

.btn-danger{
  background:linear-gradient(135deg,#3a1520,#210b12);
  border-color:rgba(255,84,112,.35);
}

.btn-accent{
  background:linear-gradient(135deg,#12313a,#0a1e25);
  border-color:rgba(94,224,255,.4);
}

/* GRID */
.grid-2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.tiny{
  font-size:12px;
  color:var(--muted);
}

/* RESPONSIVE */
@media (max-width:724px){
  .wrap{ max-width:680px; padding:16px; }
  .card{ padding:14px; }
}
  
@media (max-width:820px) and (orientation:landscape){
  .wrap{ max-width:100%; padding:14px; }
  .grid-2{ grid-template-columns:1fr 1fr; }
}
@media (max-width:480px){
  .wrap{ max-width:100%; padding:12px; }
  .grid-2{ grid-template-columns:1fr; }
}

/* ------------------------------- */
/*       MINI LIVE PREVIEW FIXED   */
/* ------------------------------- */
#miniPreview{
  position:sticky;
  top:0;
  z-index:999;
  background:rgba(10,12,20,.85);
  backdrop-filter:blur(6px);
  border-radius:14px;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 6px 18px rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.08);
}

#miniLeft, #miniRight{
  display:flex;
  flex-direction:column;
  gap:4px;
  text-align:center;
  font-weight:700;
  min-width:60px;
}

#miniCenter{
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
}

#miniScoreA, #miniScoreB{
  font-size:28px;
  font-weight:900;
}

#miniClock{
  font-size:26px;
  font-weight:900;
}

#miniShot{
  font-size:22px;
  margin-top:-4px;
}

.mini-chip{
  font-size:12px;
  padding:2px 6px;
  border-radius:6px;
  background:rgba(255,255,255,.1);
}

.mini-active{
  background:var(--accent);
  color:#000;
}

/* ------------------------------- */
/*         CLOCK SECTION           */
/* ------------------------------- */

.clock-block{
  display:flex;
  justify-content:space-between;
}

#numpad{
  display:grid;
  grid-template-columns:repeat(3, 36px);
  gap:6px;
  margin-left:auto;
  margin-right:10px;
}

#numpad button{
  padding:10px;
  font-size:18px;
  min-width:36px;
  min-height:36px;
}

/* ------------------------------- */
/*         SCORES SECTION          */
/* ------------------------------- */

.score-box{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.score-team{
  background:rgba(255,255,255,0.08);
  padding:12px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* Layout affiancato Clock + Scores */
.top-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
  align-items:flex-start;
}

@media (max-width:700px) and (orientation:portrait){
  .top-row{
    grid-template-columns:1fr;
  }
}

/* Score verticali (Home sopra, Away sotto) */
.score-vert{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.score-team .btn-row{
  display:flex;
  gap:8px;
}

.score-team button{
  min-width:40px;
  min-height:45px;
  font-size:18px;
  font-weight:800;
  border-radius:10px;
}

/* Riduzione in altezza della sezione Clock */
.clock-card{
  padding:10px 14px;
}

.clock-card .row{
  margin-bottom:4px;
}

.clock-card button{
  padding:6px 10px;
  min-height:32px;
  font-size:14px;
}

.clock-card input,
.clock-card select{
  padding:6px 8px;
  font-size:14px;
}

/* numpad più piccolo */
.clock-card #numpad{
  grid-template-columns:repeat(3, 30px);
  gap:4px;
}

.clock-card #numpad button{
  min-width:30px;
  min-height:30px;
  padding:4px;
  font-size:14px;
}
</style>
</head>

<body>

<div class="wrap">

<!-- MINI PREVIEW -->
<div class="card" id="miniPreview">
  <div id="miniLeft">
    <div class="tiny">C</div>
    <div id="miniScoreA">0</div>
    <div class="mini-chip" id="miniFoulsA">F:0</div>
    <div class="mini-chip" id="miniBonusA">BONUS</div>
  </div>

  <div id="miniCenter">
    <div id="miniClock">12:00</div>
    <div id="miniShot">24</div>
    <div class="mini-chip">P <span id="miniPeriod">1</span></div>
  </div>

  <div id="miniRight">
    <div class="tiny">O</div>
    <div id="miniScoreB">0</div>
    <div class="mini-chip" id="miniFoulsB">F:0</div>
    <div class="mini-chip" id="miniBonusB">BONUS</div>
  </div>
</div>

<!-- RIGA SUPERIORE: CLOCK + SCORES -->
<div class="top-row">

  <!-- GAME CLOCK & SHOT CLOCK -->
  <div class="card clock-card">
    <h2>Game Clock & Shot Clock</h2>

    <div class="clock-block">

      <!-- LEFT SIDE -->
      <div style="display:flex; flex-direction:column; gap:10px;">

        <div class="row">
          <button id="clkStart" class="btn-accent">Start</button>
          <button id="clkStop">Stop</button>
        </div>

        <div class="row">
          <input type="text" id="clkSet" placeholder="mm:ss" style="width:120px" />
          <button id="clkApply">Apply</button>
        </div>

        <div class="row">
          <select id="clkPreset">
            <option value="720000">12:00</option>
            <option value="600000">10:00</option>
            <option value="480000">08:00</option>
            <option value="360000">06:00</option>
          </select>
          <button id="clkPresetApply">Reset</button>
        </div>

        <div class="row">
          <button id="shotReset">Shot 24</button>
          <button id="shotDisable" class="btn-danger">Shot OFF</button>
        </div>

        <div class="row">
          <input type="number" id="shotSet" min="1" max="99" value="24" style="width:80px" />
          <button id="shotApply">Apply</button>
        </div>

      </div>

      <!-- NUMPAD -->
      <div id="numpad">
        <button data-num="1">1</button>
        <button data-num="2">2</button>
        <button data-num="3">3</button>
        <button data-num="4">4</button>
        <button data-num="5">5</button>
        <button data-num="6">6</button>
        <button data-num="7">7</button>
        <button data-num="8">8</button>
        <button data-num="9">9</button>
        <button style="visibility:hidden;"></button>
        <button data-num="0">0</button>
        <button id="numpadClear" class="btn-danger">C</button>
      </div>

    </div>

    <div class="tiny">
      Shortcuts: Space = Start/Stop · R = Shot 24 · F = Shot disabled · +/- = Shot ±1
    </div>
  </div>

  <!-- SCORES -->
  <div class="card">
    <h2>Scores</h2>

    <div class="score-vert">

      <!-- HOME -->
      <div class="score-team">
        <div><strong>Home</strong></div>
        <div class="btn-row">
          <button data-delta="-1" data-target="A" class="btn-danger">-1</button>
          <button data-delta="1"  data-target="A">+1</button>
          <button data-delta="2"  data-target="A">+2</button>
          <button data-delta="3"  data-target="A">+3</button>
        </div>
      </div>

      <!-- AWAY -->
      <div class="score-team">
        <div><strong>Away</strong></div>
        <div class="btn-row">
          <button data-delta="-1" data-target="B" class="btn-danger">-1</button>
          <button data-delta="1"  data-target="B">+1</button>
          <button data-delta="2"  data-target="B">+2</button>
          <button data-delta="3"  data-target="B">+3</button>
        </div>
      </div>

    </div>

    <div class="row" style="justify-content:center; margin-top:10px;">
      <button id="resetScores" class="btn-danger" style="min-width:200px;">Reset Scores</button>
    </div>
  </div>

</div> <!-- fine .top-row -->


<!-- PERIOD & TIMEOUTS -->
<div class="card">
  <h2>Period & Timeouts</h2>

  <div class="row">
    <button id="perDec">Period -</button>
    <span class="tiny">Current: <strong id="periodView">1</strong></span>
    <button id="perInc">Period +</button>
  </div>

  <div class="row">
    <button id="toDec">TO -</button>
    <span class="tiny">Current: <strong id="timeoutsView">7</strong></span>
    <button id="toInc">TO +</button>
  </div>
</div>

<!-- FOULS & BONUS -->
<div class="card">
  <h2>Fouls & Bonus</h2>

  <div class="grid-2">

    <div>
      <div class="row">
        <span class="tiny">Home Fouls: <strong id="foulsAView">0</strong></span>
      </div>
      <div class="row">
        <button data-foul="A" data-delta="-1" class="btn-danger">-1</button>
        <button data-foul="A" data-delta="1">+1</button>
        <button id="bonusAToggle">Toggle Bonus</button>
      </div>
    </div>

    <div>
      <div class="row">
        <span class="tiny">Away Fouls: <strong id="foulsBView">0</strong></span>
      </div>
      <div class="row">
        <button data-foul="B" data-delta="-1" class="btn-danger">-1</button>
        <button data-foul="B" data-delta="1">+1</button>
        <button id="bonusBToggle">Toggle Bonus</button>
      </div>
    </div>

  </div>

  <div class="row" style="justify-content:center;">
    <button id="resetFouls" class="btn-danger" style="min-width:200px;">Reset Fouls</button>
  </div>
</div>

<!-- POSSESSION -->
<div class="card">
  <h2>Possession Arrow</h2>
  <div class="row">
    <button id="possA">Home Possession</button>
    <button id="possB">Away Possession</button>
    <button id="possClear" class="btn-danger">Clear</button>
  </div>
</div>

<!-- TEAMS -->
<div class="card">
  <h2>Teams</h2>

  <div class="row">
    <input type="text" id="inNameA" placeholder="Home team name" />
    <input type="file" id="inLogoA" accept="image/*" />
  </div>

  <div class="row">
    <input type="text" id="inNameB" placeholder="Away team name" />
    <input type="file" id="inLogoB" accept="image/*" />
  </div>

  <div class="row">
    <button id="swapTeams">Swap Sides</button>
    <button id="resetLogos">Clear Logos</button>
  </div>
</div>

<!-- UTILITIES -->
<div class="card">
  <h2>Utilities</h2>

  <div class="row">
    <button id="saveState">Save State</button>
    <button id="loadState">Load State</button>
    <button id="forceSync" class="btn-accent">Force Sync</button>
    <button id="resetAll" class="btn-danger">Reset All</button>
    <button id="forceReload" class="btn-accent">Forza Refresh Overlay</button>
  </div>
</div>

</div> <!-- end .wrap -->


<!-- FIREBASE + CONTROLLER -->
<script type="module">
/* 1. IMPORT FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase,
  ref,
  update,
  set,
  serverTimestamp,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* 2. CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDxuUUK8xbO50mERK2hU6xxwgBW9tf10wI",
  authDomain: "anzio-scoreboard.firebaseapp.com",
  databaseURL: "https://anzio-scoreboard-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "anzio-scoreboard",
  storageBucket: "anzio-scoreboard.firebasestorage.app",
  messagingSenderId: "1070047467007",
  appId: "1:1070047467007:web:eebd383f3f45f7943483ca",
  measurementId: "G-HJB4DC7GN7"
};
  
const GAME_ID =
  new URLSearchParams(location.search).get("game") ||
  "anzio-scoreboard-3d8bb";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const stateRef = ref(db, `games/${GAME_ID}/state`);
const metaRef  = ref(db, `games/${GAME_ID}/meta`);

/* 3. DOM HELPER */
const $ = sel => document.querySelector(sel);

/* 4. STATE */
const state = {
  nameA: "Home",
  nameB: "Away",
  logoA: "",
  logoB: "",

  scoreA: 0,
  scoreB: 0,

  foulsA: 0,
  foulsB: 0,

  bonusA: false,
  bonusB: false,

  period: 1,
  timeouts: 7,

  gameClockMS: 12 * 60 * 1000,
  gameRunning: false,

  shotClock: 24,
  shotEnabled: true,

  poss: null
};

/* 5. ELEMENTS */
const c = {

  /* mini preview */
  miniScoreA: $('#miniScoreA'),
  miniScoreB: $('#miniScoreB'),
  miniFoulsA: $('#miniFoulsA'),
  miniFoulsB: $('#miniFoulsB'),
  miniBonusA: $('#miniBonusA'),
  miniBonusB: $('#miniBonusB'),
  miniClock:  $('#miniClock'),
  miniShot:   $('#miniShot'),
  miniPeriod: $('#miniPeriod'),

  /* clock */
  clkStart: $('#clkStart'),
  clkStop:  $('#clkStop'),
  clkSet:   $('#clkSet'),
  clkApply: $('#clkApply'),
  clkPreset: $('#clkPreset'),
  clkPresetApply: $('#clkPresetApply'),

  /* shot */
  shotReset: $('#shotReset'),
  shotSet: $('#shotSet'),
  shotApply: $('#shotApply'),
  shotDisable: $('#shotDisable'),

  /* numpad */
  numpad: $('#numpad'),
  numpadClear: $('#numpadClear'),

  /* scores */
  resetScores: $('#resetScores'),

  /* period & timeouts */
  periodView: $('#periodView'),
  timeoutsView: $('#timeoutsView'),
  perDec: $('#perDec'),
  perInc: $('#perInc'),
  toDec:  $('#toDec'),
  toInc:  $('#toInc'),

  /* fouls */
  foulsAView: $('#foulsAView'),
  foulsBView: $('#foulsBView'),
  resetFouls: $('#resetFouls'),
  bonusAToggle: $('#bonusAToggle'),
  bonusBToggle: $('#bonusBToggle'),

  /* possession */
  possA: $('#possA'),
  possB: $('#possB'),
  possClear: $('#possClear'),

  /* teams */
  inNameA: $('#inNameA'),
  inNameB: $('#inNameB'),
  inLogoA: $('#inLogoA'),
  inLogoB: $('#inLogoB'),
  swapTeams: $('#swapTeams'),
  resetLogos: $('#resetLogos'),

  /* utilities */
  saveState: $('#saveState'),
  loadState: $('#loadState'),
  forceSync: $('#forceSync'),
  resetAll: $('#resetAll'),
  forceReload: $('#forceReload')
};

/* 6. PREVIEW */
function fmt(ms) {
  const m = Math.floor(ms / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function renderPreview() {
  c.miniScoreA.textContent = state.scoreA;
  c.miniScoreB.textContent = state.scoreB;

  c.miniFoulsA.textContent = "F:" + state.foulsA;
  c.miniFoulsB.textContent = "F:" + state.foulsB;

  c.miniBonusA.classList.toggle("mini-active", state.bonusA);
  c.miniBonusB.classList.toggle("mini-active", state.bonusB);

  c.miniClock.textContent = fmt(state.gameClockMS);
  c.miniShot.textContent = state.shotEnabled ? state.shotClock : "--";

  c.miniPeriod.textContent = state.period;
}

/* 7. PUSH FIREBASE */
let dirty = true;

const pushNow = () => {
  update(stateRef, { ...state }).then(() => {
    update(metaRef, { updatedAt: serverTimestamp() });
  });
  dirty = false;
};

setInterval(() => {
  if (dirty) pushNow();
}, 200);

function markDirty() {
  dirty = true;
}

/* 8. CLOCK ENGINE */
let lastTick = 0;
let lastShotTick = 0;
let rafId = null;

function tick(ts) {
  if (!lastTick) lastTick = ts;
  if (!lastShotTick) lastShotTick = ts;

  const dt = ts - lastTick;
  lastTick = ts;

  if (state.gameRunning) {
    state.gameClockMS = Math.max(0, state.gameClockMS - dt);

    if (state.shotEnabled && ts - lastShotTick >= 1000) {
      state.shotClock = Math.max(0, state.shotClock - 1);
      lastShotTick = ts;
    }

    markDirty();
    renderPreview();
  }

  rafId = requestAnimationFrame(tick);
}
rafId = requestAnimationFrame(tick);

/* 9. CLOCK BUTTONS */
c.clkStart.addEventListener("click", () => {
  state.gameRunning = true;
  lastTick = 0;
  lastShotTick = 0;
  markDirty();
});

c.clkStop.addEventListener("click", () => {
  state.gameRunning = false;
  markDirty();
});

c.clkApply.addEventListener("click", () => {
  const m = /^([0-9]{1,2}):([0-5][0-9])$/.exec(c.clkSet.value.trim());
  if (!m) return;
  state.gameClockMS = (+m[1] * 60 + +m[2]) * 1000;
  markDirty();
  renderPreview();
});

c.clkPresetApply.addEventListener("click", () => {
  state.gameClockMS = parseInt(c.clkPreset.value);
  markDirty();
  renderPreview();
});

/* 10. SHOT CLOCK */
c.shotReset.addEventListener("click", () => {
  if (state.shotEnabled) state.shotClock = 24;
  markDirty();
  renderPreview();
});

c.shotApply.addEventListener("click", () => {
  const v = Math.max(1, Math.min(99, +c.shotSet.value || 24));
  state.shotClock = v;
  markDirty();
  renderPreview();
});

c.shotDisable.addEventListener("click", () => {
  state.shotEnabled = !state.shotEnabled;
  c.shotDisable.textContent = state.shotEnabled ? "Shot OFF" : "Shot ON";
  markDirty();
  renderPreview();
});

/* 11. NUMPAD */
c.numpad.addEventListener("click", e => {
  const btn = e.target.closest("button[data-num]");
  if (!btn) return;

  let current = c.clkSet.value.replace(":", "");
  if (current.length >= 4) current = "";

  current += btn.dataset.num;

  if (current.length <= 2) {
    c.clkSet.value = current.padStart(1, "0");
  } else {
    let m = current.slice(0, -2);
    let s = current.slice(-2);
    c.clkSet.value = `${m}:${s}`;
  }
});

c.numpadClear.addEventListener("click", () => {
  c.clkSet.value = "";
});

/* 12. SCORES */
document.addEventListener("click", e => {
  const btn = e.target.closest("button[data-delta][data-target]");
  if (!btn) return;

  const delta = +btn.dataset.delta;
  const key = btn.dataset.target === "A" ? "scoreA" : "scoreB";

  state[key] = Math.max(0, state[key] + delta);
  markDirty();
  renderPreview();
});

c.resetScores.addEventListener("click", () => {
  state.scoreA = 0;
  state.scoreB = 0;
  markDirty();
  renderPreview();
});

/* 13. FOULS & BONUS */
document.addEventListener("click", e => {
  const btn = e.target.closest("button[data-foul]");
  if (!btn) return;

  const delta = +btn.dataset.delta;
  const key = btn.dataset.foul === "A" ? "foulsA" : "foulsB";

  state[key] = Math.max(0, state[key] + delta);
  markDirty();
  renderPreview();
});

c.resetFouls.addEventListener("click", () => {
  state.foulsA = 0;
  state.foulsB = 0;
  state.bonusA = false;
  state.bonusB = false;
  markDirty();
  renderPreview();
});

c.bonusAToggle.addEventListener("click", () => {
  state.bonusA = !state.bonusA;
  markDirty();
  renderPreview();
});

c.bonusBToggle.addEventListener("click", () => {
  state.bonusB = !state.bonusB;
  markDirty();
  renderPreview();
});

/* 14. PERIOD & TIMEOUTS */
c.perDec.addEventListener("click", () => {
  state.period = Math.max(1, state.period - 1);
  markDirty();
  renderPreview();
  c.periodView.textContent = state.period;
});
c.perInc.addEventListener("click", () => {
  state.period = Math.min(9, state.period + 1);
  markDirty();
  renderPreview();
  c.periodView.textContent = state.period;
});

c.toDec.addEventListener("click", () => {
  state.timeouts = Math.max(0, state.timeouts - 1);
  markDirty();
  c.timeoutsView.textContent = state.timeouts;
});
c.toInc.addEventListener("click", () => {
  state.timeouts = Math.min(10, state.timeouts + 1);
  markDirty();
  c.timeoutsView.textContent = state.timeouts;
});

/* 15. POSSESSION */
c.possA.addEventListener("click", () => {
  state.poss = "A";
  markDirty();
});
c.possB.addEventListener("click", () => {
  state.poss = "B";
  markDirty();
});
c.possClear.addEventListener("click", () => {
  state.poss = null;
  markDirty();
});

/* 16. TEAMS */
c.inNameA.addEventListener("input", e => {
  state.nameA = e.target.value || "Home";
  markDirty();
});

c.inNameB.addEventListener("input", e => {
  state.nameB = e.target.value || "Away";
  markDirty();
});

function loadLogo(file, key) {
  if (!file) return;
  const r = new FileReader();
  r.onload = () => {
    state[key] = r.result;
    markDirty();
  };
  r.readAsDataURL(file);
}

c.inLogoA.addEventListener("change", e => loadLogo(e.target.files[0], "logoA"));
c.inLogoB.addEventListener("change", e => loadLogo(e.target.files[0], "logoB"));

c.swapTeams.addEventListener("click", () => {
  [state.nameA, state.nameB] = [state.nameB, state.nameA];
  [state.logoA, state.logoB] = [state.logoB, state.logoA];
  [state.scoreA, state.scoreB] = [state.scoreB, state.scoreA];
  [state.foulsA, state.foulsB] = [state.foulsB, state.foulsA];
  state.poss = state.poss === "A" ? "B" :
               state.poss === "B" ? "A" : null;

  markDirty();
  renderPreview();
});

c.resetLogos.addEventListener("click", () => {
  state.logoA = "";
  state.logoB = "";
  markDirty();
});

/* 17. UTILITIES */
c.saveState.addEventListener("click", () => {
  localStorage.setItem("pro-scoreboard", JSON.stringify(state));
  alert("Saved locally");
});

c.loadState.addEventListener("click", () => {
  try {
    const data = JSON.parse(localStorage.getItem("pro-scoreboard") || "{}");
    Object.assign(state, data);
    markDirty();
    renderPreview();
  } catch (e) {}
});

c.forceSync.addEventListener("click", () => {
  dirty = true;
  pushNow();
  alert("Forced sync sent!");
});

c.resetAll.addEventListener("click", () => {
  Object.assign(state, {
    nameA: "Home",
    nameB: "Away",
    logoA: "",
    logoB: "",
    scoreA: 0,
    scoreB: 0,
    foulsA: 0,
    foulsB: 0,
    bonusA: false,
    bonusB: false,
    period: 1,
    timeouts: 7,
    gameClockMS: 12 * 60 * 1000,
    gameRunning: false,
    shotClock: 24,
    shotEnabled: true,
    poss: null
  });

  markDirty();
  renderPreview();
});

/* Forza Refresh Overlay */
c.forceReload.addEventListener("click", () => {
  update(ref(db, "/overlayReload"), { nonce: Date.now() });
  alert("Richiesta di refresh inviata all'overlay.");
});

/* 18. CONTROLLER PRESENCE */
onDisconnect(metaRef).update({ controllerOnline:false });

update(metaRef, {
  controllerOnline: true,
  updatedAt: serverTimestamp(),
  gameId: GAME_ID
});

renderPreview();
pushNow();
</script>

</body>
</html>
